---
- name: üõ°Ô∏è Configuraci√≥n de Red e Infraestructura (Incus Hypervisor)
  hosts: localhost
  connection: local
  gather_facts: no  # No necesitamos facts de localhost, va m√°s r√°pido as√≠
  vars:
    # üìù LA VERDAD ABSOLUTA DE LAS IPs (Esquema limpio)
    containers:
      - name: omni-vm
        ip: "10.2.84.10"   # Gateway
      
      - name: argus-vm
        ip: "10.2.84.20"   # Monitorizaci√≥n
      
      - name: phoenix-vm
        ip: "10.2.84.30"   # App Producci√≥n
      
      - name: broom-vm
        ip: "10.2.84.40"   # Utilidades
      
      - name: legami-vm
        ip: "10.2.84.50"   # Legacy/Otros
      
      - name: forge-vm
        ip: "10.2.84.60"   # CI/CD & Registry

  tasks:
    - name: üîç Verificar y Aplicar IP Est√°tica (Solo si es necesario)
      shell: |
        # 1. Obtener la IP configurada actualmente (si existe)
        CURRENT_IP=$(incus config device get {{ item.name }} eth0 ipv4.address 2>/dev/null || echo "none")
        
        # 2. Comparar con la deseada
        if [ "$CURRENT_IP" != "{{ item.ip }}" ]; then
            echo "CHANGE_NEEDED"
            # Intentar override (si viene del perfil) o set (si ya tiene override)
            incus config device override {{ item.name }} eth0 ipv4.address={{ item.ip }} 2>/dev/null || \
            incus config device set {{ item.name }} eth0 ipv4.address={{ item.ip }}
        else
            echo "OK"
        fi
      loop: "{{ containers }}"
      register: ip_config_result
      # Solo marcamos "changed" si el script imprimi√≥ "CHANGE_NEEDED"
      changed_when: "'CHANGE_NEEDED' in ip_config_result.stdout"

    - name: ‚ôªÔ∏è Reiniciar contenedores (Solo los que han cambiado)
      shell: |
        incus restart {{ item.item.name }}
      loop: "{{ ip_config_result.results }}"
      when: item.changed  # <--- ¬°LA MAGIA! Solo reinicia si cambi√≥ la IP
      async: 60           # No bloquea indefinidamente
      poll: 0             # Lanzamos el reinicio y seguimos (esperamos abajo)

    - name: ‚è≥ Esperar a que las m√°quinas respondan
      wait_for:
        host: "{{ item.item.ip }}"
        state: started
        timeout: 60
      loop: "{{ ip_config_result.results }}"
      when: item.changed
      delegate_to: localhost