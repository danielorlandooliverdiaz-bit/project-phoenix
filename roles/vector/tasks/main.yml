---
- name: â¬‡ï¸ Descargar paquete .deb de Vector
  get_url:
    url: "https://packages.timber.io/vector/0.36.0/vector_0.36.0-1_amd64.deb"
    dest: "/tmp/vector.deb"
    mode: '0644'

- name: ğŸ“¦ Instalar Vector desde el archivo .deb
  apt:
    deb: "/tmp/vector.deb"
    state: present

- name: ğŸ‘® AÃ±adir usuario 'vector' a grupos de lectura de logs
  user:
    name: vector
    groups: adm,systemd-journal
    append: yes

- name: ğŸ“‚ Asegurar permisos correctos en carpeta de datos
  file:
    path: /var/lib/vector
    state: directory
    owner: vector
    group: vector
    mode: '0755'
    recurse: yes

# --- LIMPIEZA DE INTENTOS ANTERIORES (Por si acaso) ---
- name: ğŸ§¹ Borrar configuraciones antiguas (TOML y Overrides)
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/vector/vector.toml
    - /etc/systemd/system/vector.service.d
# -----------------------------------------------------

- name: âš™ï¸ Configurar Vector (Usando el estÃ¡ndar YAML)
  template:
    src: vector.yaml.j2       # <--- Usamos la nueva plantilla
    dest: /etc/vector/vector.yaml  # <--- Ruta por defecto que busca el servicio
    owner: vector
    group: vector
    mode: '0644'
    force: yes
  notify: restart_vector

- name: ğŸ”„ Recargar Systemd (Por si borramos overrides)
  systemd:
    daemon_reload: yes

- name: ğŸš€ Asegurar que el servicio Vector estÃ¡ activo
  systemd:
    name: vector
    state: started
    enabled: yes