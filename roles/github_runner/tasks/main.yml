---
- name: ðŸ“¦ Crear usuario para el Runner
  user:
    name: runner
    groups: docker
    shell: /bin/bash
    append: yes

- name: ðŸ“‚ Crear directorio del Runner
  file:
    path: /opt/actions-runner
    state: directory
    owner: runner
    group: runner
    mode: '0755'

- name: â¬‡ï¸ Descargar GitHub Actions Runner (v2.311.0)
  unarchive:
    src: https://github.com/actions/runner/releases/download/v2.311.0/actions-runner-linux-x64-2.311.0.tar.gz
    dest: /opt/actions-runner
    remote_src: yes
    owner: runner
    group: runner
    creates: /opt/actions-runner/bin/Runner.Listener  # Solo descarga si no existe

- name: âš™ï¸ Instalar dependencias de .NET (Necesarias para el Runner)
  apt:
    pkg:
      - acl
      - libicu-dev
      - libssl-dev
      - tar
    state: present

# AQUÃ VIENE LA MAGIA: Registro automÃ¡tico
- name: ðŸ”‘ Registrar el Runner en GitHub (Si no existe ya)
  become_user: runner
  command: >
    ./config.sh --url https://github.com/{{ github_repo }} 
    --token {{ github_token }} 
    --name "{{ inventory_hostname }}" 
    --work _work 
    --unattended 
    --replace
  args:
    chdir: /opt/actions-runner
    creates: /opt/actions-runner/.credentials  # Evita registrarse dos veces

- name: ðŸ“„ Instalar el servicio Systemd del Runner
  command: ./svc.sh install runner
  args:
    chdir: /opt/actions-runner
  ignore_errors: true  # Ignora error si ya estÃ¡ instalado

- name: ðŸš€ Arrancar el servicio del Runner
  command: ./svc.sh start
  args:
    chdir: /opt/actions-runner
  ignore_errors: true