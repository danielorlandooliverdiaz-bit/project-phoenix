---
# --- CONFIGURACIÓN FIREWALL (UFW) ---
- name: Permitir SSH en UFW (Para no bloquearnos)
  ufw:
    rule: allow
    name: OpenSSH

- name: Permitir puertos TCP definidos en variables
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop: "{{ security_allowed_tcp_ports }}"

- name: Activar UFW y denegar todo lo demás por defecto
  ufw:
    state: enabled
    policy: deny

# --- HARDENING SSH ---
- name: Prohibir login de root por SSH
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PermitRootLogin'
    line: 'PermitRootLogin no'
    state: present

- name: Prohibir autenticación por contraseña (SOLO LLAVES)
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PasswordAuthentication'
    line: 'PasswordAuthentication no'
    state: present

# --- REINICIO DIRECTO ---
- name: Reiniciar servicio SSH para aplicar cambios
  service:
    name: ssh
    state: restarted
